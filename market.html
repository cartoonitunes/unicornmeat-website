<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unicorn Market ‚Äî Onchain Orderbook for ü¶Ñ ‚áÑ wüçñ</title>
    <link rel="icon" type="image/png" href="/assets/favicon.ico" />
    <link rel="canonical" href="https://unicornmeateth.com/market" />
    <link rel="alternate" type="text/plain" href="https://unicornmeateth.com/llms.txt" title="LLM Information" />
    <meta name="description" content="Unicorn Market ‚Äî a fully onchain orderbook for trading Unicorns (ü¶Ñ) and Wrapped Unicorn Meat (wüçñ). Place bids, asks, and fill orders transparently on Ethereum.">
    <meta name="theme-color" content="#FFBA00">
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Unicorn Market ü¶Ñüçñ">
    <meta property="og:description" content="Onchain orderbook for trading Unicorns and Wrapped Unicorn Meat on Ethereum.">
    <meta property="og:url" content="https://unicornmeateth.com/market">
    <meta property="og:site_name" content="Unicorn Meat üçñ">
    <meta property="og:image" content="https://gaccdiscordimages.s3.us-east-1.amazonaws.com/unicornmeat-ogsocial.png">
    <meta property="og:image:width" content="1180">
    <meta property="og:image:height" content="600">
    <meta property="og:image:type" content="image/png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Unicorn Market ü¶Ñüçñ">
    <meta name="twitter:description" content="Onchain orderbook for trading Unicorns and Wrapped Unicorn Meat on Ethereum.">
    <meta name="twitter:image" content="https://gaccdiscordimages.s3.us-east-1.amazonaws.com/unicornmeat-ogsocial.png">
    <script src="/assets/js/app-head-bs.js"></script>
    <link rel="stylesheet" href="/assets/js/uni-core/css/uni-core.min.css">
    <link rel="stylesheet" href="/assets/css/unicons.min.css">
    <link rel="stylesheet" href="/assets/css/swiper-bundle.min.css">
    <link rel="stylesheet" href="/assets/css/prettify.min.css">
    <link rel="stylesheet" href="/assets/css/magic-cursor.min.css">
    <link rel="stylesheet" href="/assets/css/theme/theme-two.min.purge.css">
    <script src="/assets/js/uni-core/js/uni-core-bundle.min.js"></script>
    <link rel="stylesheet" href="/assets/css/theme/hero-bg.css">
    <link rel="stylesheet" href="/assets/css/custom.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.1/ethers.umd.min.js" crossorigin="anonymous"></script>
    <style>
        .skip-to-content { position:absolute;top:-40px;left:0;background:#000;color:#fff;padding:8px 16px;z-index:10000;transition:top .2s; }
        .skip-to-content:focus { top:0; }
        @media (max-width:576px) { .btn-responsive-text { font-size:.8rem!important; } }

        /* Market-specific styles */
        .ask-color { color: #cc3a57; font-weight: 700; }
        .bid-color { color: #118a68; font-weight: 700; }

        .market-grid { display:grid; gap:12px; }
        @media (min-width:980px) { .market-grid { grid-template-columns:1fr 1.2fr 1fr; } }

        .market-row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px dashed #ddd; font-size:13px; }
        .market-row:last-child { border-bottom:0; }

        .stats-grid { display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:8px; margin:10px 0 8px; }
        .stat-card { text-align:center; }
        .stat-card .k { display:block; font-size:11px; color:#555; text-transform:uppercase; letter-spacing:.05em; }
        .stat-card .v { display:block; margin-top:3px; font-weight:800; font-size:13px; }

        .depth-wrap { padding:8px; margin-bottom:8px; }
        .depth-row { position:relative; display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center; padding:5px 6px; font-size:12px; overflow:hidden; border-radius:6px; }
        .depth-row .bar { position:absolute; top:0; bottom:0; opacity:.18; z-index:0; border-radius:6px; transition:width .35s ease; }
        .depth-row.ask .bar { right:0; background:#cc3a57; }
        .depth-row.bid .bar { left:0; background:#118a68; }
        .depth-row span { position:relative; z-index:1; }
        .depth-mid { text-align:center; font-size:12px; font-weight:700; padding:6px; border-top:1px dashed #ccc; border-bottom:1px dashed #ccc; margin:6px 0; }

        .ledger-scroll { max-height:220px; overflow:auto; }
        .my-orders { margin-top:10px; border-top:1px dashed #ddd; padding-top:10px; }
        .my-order-row { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:6px 0; border-bottom:1px dashed #eee; font-size:12px; }
        .my-order-row:last-child { border-bottom:0; }

        .take-btn { width:auto; margin:0; padding:4px 10px; font-size:11px; border-radius:8px; background:#d4edda; color:#155724; border:1px solid #155724; font-weight:700; cursor:pointer; }
        .take-btn:hover { background:#c3e6cb; }
        .cancel-btn { width:auto; margin:0; padding:4px 10px; font-size:11px; border-radius:8px; background:#f4f4f4; color:#333; border:1px solid #999; font-weight:700; cursor:pointer; }
        .cancel-btn:hover { background:#e9e9e9; }

        details.method { margin:8px 0; overflow:hidden; }
        details.method summary { cursor:pointer; font-weight:700; font-size:12px; padding:8px 10px; background:linear-gradient(135deg,#ffe0ec,#ffd0df); border-bottom:1px dashed #bbb; }
        pre.code { margin:0; padding:10px; background:#101318 !important; color:#e8edf3 !important; overflow-x:hidden; max-width:100%; white-space:pre-wrap; word-break:break-all; font-size:11px; line-height:1.45; border-radius: 0 0 8px 8px; }
        .kw{color:#ff7ab6;font-weight:700;} .fn{color:#7dcfff;} .var{color:#c3e88d;} .num{color:#f7c873;} .addr{color:#82aaff;}

        .how-it-works-grid { display:grid; gap:12px; }
        @media (min-width:768px) { .how-it-works-grid { grid-template-columns:repeat(4,1fr); } }
        .step-num { display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:50%; font-weight:800; font-size:14px; }

        /* Production additions */
        .network-warning { background:#fff3cd; color:#856404; border:2px solid #856404; padding:10px 16px; text-align:center; font-weight:700; font-size:13px; position:fixed; top:0; left:0; right:0; z-index:10001; }
        .tx-status { font-size:12px; padding:6px 10px; border-radius:8px; margin-top:6px; word-break:break-word; }
        .tx-status.pending { background:#fff3cd; color:#856404; }
        .tx-status.success { background:#d4edda; color:#155724; }
        .tx-status.error { background:#f8d7da; color:#721c24; }
        .balances { display:flex; gap:8px; margin-bottom:8px; font-size:12px; flex-wrap:wrap; }
        .balances .bal { background:#f0f4f8; padding:4px 8px; border-radius:6px; font-weight:600; }
        .fill-inline { display:flex; gap:4px; align-items:center; margin-top:4px; flex-wrap:wrap; }
        .fill-inline input { width:70px; padding:3px 6px; font-size:11px; border:1px solid #999; border-radius:6px; }
        .fill-inline button { padding:3px 8px; font-size:10px; border-radius:6px; cursor:pointer; font-weight:700; border:1px solid; white-space:nowrap; }
        .fill-confirm { background:#d4edda; color:#155724; border-color:#155724; }
        .fill-all { background:#cce5ff; color:#004085; border-color:#004085; }
        .order-stale { opacity:0.5; }

        /* Mobile fixes */
        #create-order { font-size:14px; padding:10px 12px; white-space:normal; word-break:break-word; line-height:1.3; min-height:44px; }
        @media (max-width:576px) {
            #create-order { font-size:13px; padding:10px 8px; }
            .market-grid { gap:16px; }
            .stats-grid { grid-template-columns:repeat(2,1fr); }
            .market-row { font-size:12px; gap:4px; flex-wrap:wrap; }
            .take-btn, .cancel-btn { font-size:10px; padding:3px 8px; }
            .depth-row { font-size:11px; }
            .my-order-row { font-size:11px; flex-wrap:wrap; }
            .how-it-works-grid { grid-template-columns:repeat(2,1fr); }
            details.method summary { font-size:11px; padding:6px 8px; }
            pre.code { font-size:10px; padding:8px; }
            .fill-inline input { width:60px; }
            #transparency { overflow:hidden; }
        }
        @media (max-width:380px) {
            .stats-grid { grid-template-columns:1fr 1fr; gap:6px; }
            .stat-card .v { font-size:11px; }
            .how-it-works-grid { grid-template-columns:1fr; }
        }
    </style>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "@id": "https://unicornmeateth.com/market",
        "url": "https://unicornmeateth.com/market",
        "name": "Unicorn Market",
        "description": "Fully onchain orderbook for trading Unicorns and Wrapped Unicorn Meat on Ethereum",
        "isPartOf": { "@id": "https://unicornmeateth.com/#website" }
    }
    </script>
    <link rel="llms-txt" href="https://inlay.dev/api/llms/sa_f9d4848447a04edae01a9b0eb9749c4c3c0720cfe05f5d49" />
    <link rel="mcp-manifest" type="application/json" href="https://inlay.dev/api/mcp/sa_f9d4848447a04edae01a9b0eb9749c4c3c0720cfe05f5d49/manifest" />
    <script src="https://inlay.dev/api/script/s.js" data-key="sa_f9d4848447a04edae01a9b0eb9749c4c3c0720cfe05f5d49" async></script>
</head>

<body>
    <a href="#main-content" class="skip-to-content">Skip to content</a>
    <div id="network-warning" class="network-warning" style="display:none;">‚ö†Ô∏è Please switch to Ethereum Mainnet to use Unicorn Market</div>
    <div class="uc-wrapper">
        <!-- Header start -->
        <header class="uc-header header-two uc-navbar-sticky-wrap z-999 uc-dark"
            data-uc-sticky="start: 100vh; animation: uc-animation-slide-top; sel-target: .uc-navbar-container; cls-active: uc-navbar-sticky; cls-inactive: uc-navbar-transparent; end: !*;">
            <nav class="uc-navbar-container bg-transparent mt-3 xl:mt-4 uc-navbar-float ft-tertiary z-1"
                data-anime="translateY: [-40, 0]; opacity: [0, 1]; duration: 750; delay: 0;">
                <div class="uc-navbar-main" style="--uc-nav-height: 100px">
                    <div class="container">
                        <div class="uc-navbar min-h-64px lg:min-h-80px xl:min-h-100px ps-2 pe-1 lg:px-4 border border-2 border-black contrast-shadow-md rounded-2 lg:rounded-3"
                            data-uc-navbar=" animation: uc-animation-slide-top-small; duration: 150;"
                            style="background-color: rgba(152, 206, 251, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">
                            <div class="uc-navbar-left">
                                <div class="uc-logo">
                                    <a class="panel text-none w-150px xl:w-auto" href="/">
                                        <img src="/assets/images/home-two/unicornmeat-logo.webp"
                                            alt="Unicorn Meat Logo"
                                            style="height: 40px; width: auto; filter: drop-shadow(-4px 0px 8px rgba(0,0,0,0.3));">
                                    </a>
                                </div>
                            </div>
                            <div class="uc-navbar-center">
                                <ul class="uc-navbar-nav fs-5 xl:fs-4 gap-3 lg:gap-4 d-none lg:d-flex fw-semibold"
                                    data-uc-scrollspy-nav="closet: > *; offset: 48; scroll: true;">
                                    <li><a href="#about">About</a></li>
                                    <li><a href="#orderbook">Orderbook</a></li>
                                    <li><a href="#how-it-works">How It Works</a></li>
                                    <li><a href="#transparency">Transparency</a></li>
                                </ul>
                            </div>
                            <div class="uc-navbar-right">
                                <a class="btn btn-sm xl:btn-md btn-secondary border border-2 border-black contrast-shadow-sm -rotate-2 hover:rotate-0 d-none lg:d-inline-flex connect-wallet-btn"
                                    href="#" onclick="connectWallet(); return false;">
                                    <span class="btn-responsive-text">Connect Wallet</span>
                                </a>
                                <a class="btn btn-md btn-secondary w-48px h-48px p-0 border border-2 border-black contrast-shadow-sm d-inline-flex lg:d-none"
                                    href="#uc-menu-panel" data-uc-toggle>
                                    <img class="icon icon-3"
                                        src="/assets/images/icons/menu.svg" alt="menu"
                                        data-uc-svg>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </header>
        <!-- Header end -->

        <!-- Mobile Menu Panel -->
        <div id="uc-menu-panel" data-uc-offcanvas="overlay: true;">
            <div class="uc-offcanvas-bar m-1 rounded-2 border border-2 border-black contrast-shadow-md bg-secondary-200 text-dark dark:bg-gray-900 dark:text-white">
                <header class="uc-offcanvas-header hstack justify-between items-center pb-2">
                    <div class="uc-logo">
                        <a href="/" class="h5 text-none text-gray-900 dark:text-white">
                            <img class="w-40px" src="/assets/images/home-two/unicornmeat-logo.webp"
                                alt="Unicorn Meat" style="filter: drop-shadow(-4px 0px 8px rgba(0,0,0,0.3));">
                        </a>
                    </div>
                    <button class="uc-offcanvas-close rtl:end-auto rtl:start-0 m-1 mt-2 p-0 btn border-0 dark:text-white dark:text-opacity-50 hover:text-primary hover:rotate-90 duration-150 transition-all"
                        type="button" data-uc-toggle>
                        <img class="icon icon-3" src="/assets/images/icons/close.svg" alt="close" data-uc-svg>
                    </button>
                </header>
                <div class="panel">
                    <ul class="nav-y gap-narrow fw-medium fs-6" data-uc-nav>
                        <li><a href="#about">About</a></li>
                        <li><a href="#orderbook">Orderbook</a></li>
                        <li><a href="#how-it-works">How It Works</a></li>
                        <li><a href="#transparency">Transparency</a></li>
                    </ul>
                    <div class="mt-4">
                        <a class="btn btn-md btn-secondary border border-2 border-black contrast-shadow-sm connect-wallet-btn w-100" href="#" onclick="connectWallet(); return false;">
                            <span class="btn-responsive-text">Connect Wallet</span>
                        </a>
                    </div>
                    <ul class="nav-x gap-1 mt-4">
                        <li><a class="w-32px hover:-rotate-3" href="https://x.com/UnicornMeatETH" target="_blank" rel="noopener noreferrer"
                            style="font-size:24px;display:flex;align-items:center;justify-content:center;color:#000;text-decoration:none;"><i class="fab fa-x-twitter"></i></a></li>
                        <li><a class="w-32px hover:-rotate-3" href="https://t.me/UnicornMeatETH" target="_blank" rel="noopener noreferrer"
                            style="font-size:24px;display:flex;align-items:center;justify-content:center;color:#0088cc;text-decoration:none;"><i class="fab fa-telegram"></i></a></li>
                        <li><a class="w-32px hover:-rotate-3" href="mailto:team@unicornmeateth.com" target="_blank" rel="noopener noreferrer"
                            style="font-size:24px;display:flex;align-items:center;justify-content:center;color:#6E1E71;text-decoration:none;"><i class="fas fa-envelope"></i></a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Back to Top -->
        <div class="backtotop-wrap position-fixed bottom-0 end-0 z-99 m-2 vstack">
            <a class="btn btn-sm p-0 bg-yellow text-black border border-2 border-black contrast-shadow-sm w-48px h-48px rounded-circle"
                href="to_top" data-uc-backtotop>
                <img class="icon icon-3" src="/assets/images/icons/chevron-up.svg" alt="to-top" data-uc-svg>
            </a>
        </div>

        <main id="main-content">

        <!-- Hero / About Section -->
        <div id="about" class="section panel overflow-hidden" style="padding-top: 120px;">
            <div class="section-outer panel py-6 sm:py-8 lg:py-9 xl:py-10 bg-secondary-100">
                <div class="container sm:max-w-lg xl:max-w-2xl">
                    <div class="section-inner panel">
                        <div class="section-content panel">
                            <div class="row justify-center"
                                data-anime="onview: -400; targets: >*; translateY: [24, 0]; opacity: [0, 1]; delay: anime.stagger(100, {start: 200});">
                                <div class="col-12 col-lg-8 col-xl-6">
                                    <div class="vstack items-center gap-3 sm:gap-4 text-center">
                                        <h1 class="h4 sm:h3 xl:h2 mb-0 ls-0 text-uppercase -rotate-1">ü¶Ñ Unicorn Market</h1>
                                        <p class="fs-6 sm:fs-5 xl:fs-4 mb-0">
                                            A fully onchain orderbook for <strong>ü¶Ñ ‚áÑ wüçñ</strong>. Place bids, asks, and fill orders ‚Äî all transparent, all on Ethereum. No backend, no matching engine, no middlemen.
                                        </p>
                                        <p class="fs-7 text-muted mb-0">
                                            Continuing the lineage from the early 2016 Unicorn grinder experiments. Trade legacy Ethereum tokens the way they deserve ‚Äî openly and onchain.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orderbook Section -->
        <div id="orderbook" class="section panel overflow-hidden">
            <div class="section-outer panel py-4 sm:py-6 lg:py-8">
                <div class="container">
                    <div class="market-grid">

                        <!-- Trade Ticket -->
                        <div class="panel p-3 border border-2 border-black contrast-shadow-sm bg-white rounded-2">
                            <h3 class="fs-7 fw-bold text-uppercase ls-1 text-muted mb-2">Trade Ticket</h3>
                            <div class="balances" id="balances">
                                <span class="bal">ü¶Ñ ‚Äî</span>
                                <span class="bal">wüçñ ‚Äî</span>
                            </div>
                            <select id="side" class="form-select border border-2 border-black rounded-2 mb-2 fs-6 fw-semibold" style="padding:10px;">
                                <option value="ask">Create Ask (Sell ü¶Ñ for wüçñ)</option>
                                <option value="bid">Create Bid (Offer wüçñ for ü¶Ñ)</option>
                            </select>
                            <label class="fs-7 text-muted" id="amount-label">Amount (ü¶Ñ)</label>
                            <input id="amount" placeholder="0" aria-label="amount" class="form-control border border-2 border-black rounded-2 mb-2 fs-6" style="padding:10px;" />
                            <label class="fs-7 text-muted" id="price-label">Price (wüçñ per ü¶Ñ)</label>
                            <input id="price" placeholder="0" aria-label="price" class="form-control border border-2 border-black rounded-2 mb-2 fs-6" style="padding:10px;" />
                            <button id="create-order" class="btn btn-md btn-secondary border border-2 border-black contrast-shadow-sm w-100 fw-bold">Connect Wallet</button>
                            <p id="approval-help" class="fs-7 text-muted mt-2 mb-1">Order placement uses two transactions when needed: Approve token (if allowance is insufficient), then Place Order.</p>
                            <div class="market-row mt-2"><span class="fs-7 text-muted">Preview</span><strong id="preview" class="fs-7">‚Äî</strong></div>
                            <div id="tx-status"></div>
                        </div>

                        <!-- Depth Chart + Orderbook -->
                        <div class="panel p-3 border border-2 border-black contrast-shadow-sm bg-white rounded-2">
                            <h3 class="fs-7 fw-bold text-uppercase ls-1 text-muted mb-2">Depth Chart + Orderbook</h3>
                            <div class="stats-grid" id="stats"></div>
                            <div class="depth-wrap border border-2 border-black rounded-2 bg-white" id="depth"></div>

                            <div class="market-row"><strong class="fs-7">Asks (sell ü¶Ñ)</strong><strong class="fs-7">wüçñ / ü¶Ñ</strong></div>
                            <div id="asks"><p class="fs-7 text-muted text-center py-2 mb-0">Loading...</p></div>

                            <div class="market-row" style="margin-top:6px"><strong class="fs-7">Bids (sell wüçñ)</strong><strong class="fs-7">wüçñ / ü¶Ñ</strong></div>
                            <div id="bids"><p class="fs-7 text-muted text-center py-2 mb-0">Loading...</p></div>
                        </div>

                        <!-- Ledger + My Orders + Transparency -->
                        <div class="panel p-3 border border-2 border-black contrast-shadow-sm bg-white rounded-2">
                            <h3 class="fs-7 fw-bold text-uppercase ls-1 text-muted mb-2">Ledger</h3>
                            <div class="ledger-scroll" id="ledger"><p class="fs-7 text-muted text-center py-2 mb-0">Loading events...</p></div>
                            <div class="my-orders">
                                <h3 class="fs-7 fw-bold text-uppercase ls-1 text-muted mb-1">My Open Orders</h3>
                                <div id="my-orders"><p class="fs-7 text-muted mb-0">Connect wallet to see your orders</p></div>
                            </div>

                            <div id="transparency">
                            <h3 class="fs-7 fw-bold text-uppercase ls-1 text-muted mt-3 mb-2">Contract Transparency</h3>
                            <p class="fs-7 text-muted mb-2">Approvals: maker approves token before <strong>placeOrder</strong>; taker approves counter-token before <strong>fillOrder</strong>.</p>
                            <details class="method border border-2 border-black rounded-2">
                                <summary>placeOrder(sellToken, buyToken, sellAmount, buyAmount)</summary>
                                <pre class="code"><span class="fn">IERC20</span>(<span class="var">sellToken</span>).<span class="fn">approve</span>(<span class="var">market</span>, <span class="var">sellAmount</span>);
<span class="var">market</span>.<span class="fn">placeOrder</span>(<span class="var">sellToken</span>, <span class="var">buyToken</span>, <span class="var">sellAmount</span>, <span class="var">buyAmount</span>);</pre>
                            </details>
                            <details class="method border border-2 border-black rounded-2">
                                <summary>fillOrder(orderId, sellAmountToTake)</summary>
                                <pre class="code"><span class="fn">IERC20</span>(<span class="var">order.buyToken</span>).<span class="fn">approve</span>(<span class="var">market</span>, <span class="var">buyAmountToPay</span>);
<span class="var">market</span>.<span class="fn">fillOrder</span>(<span class="var">orderId</span>, <span class="var">sellAmountToTake</span>);</pre>
                            </details>
                            <details class="method border border-2 border-black rounded-2">
                                <summary>fillOrderFull(orderId)</summary>
                                <pre class="code"><span class="fn">IERC20</span>(<span class="var">order.buyToken</span>).<span class="fn">approve</span>(<span class="var">market</span>, <span class="var">order.buyAmountRemaining</span>);
<span class="var">market</span>.<span class="fn">fillOrderFull</span>(<span class="var">orderId</span>);</pre>
                            </details>
                            <details class="method border border-2 border-black rounded-2">
                                <summary>cancelOrder(orderId)</summary>
                                <pre class="code"><span class="var">market</span>.<span class="fn">cancelOrder</span>(<span class="var">orderId</span>);</pre>
                            </details>
                            <details class="method border border-2 border-black rounded-2">
                                <summary>getOrder(orderId) ‚Üí Order</summary>
                                <pre class="code"><span class="var">market</span>.<span class="fn">getOrder</span>(<span class="var">orderId</span>);
<span class="kw">returns</span> (maker, sellToken, buyToken, sellAmountTotal, buyAmountTotal,
        sellAmountRemaining, buyAmountRemaining, createdAt, status)</pre>
                            </details>
                            <details class="method border border-2 border-black rounded-2">
                                <summary>getOrderBook(sellToken, buyToken) ‚Üí uint256[]</summary>
                                <pre class="code"><span class="var">market</span>.<span class="fn">getOrderBook</span>(<span class="addr">UNICORN</span>, <span class="addr">W_MEAT</span>);
<span class="kw">returns</span> [<span class="num">1</span>, <span class="num">3</span>, <span class="num">7</span>, ...]</pre>
                            </details>
                            <p class="fs-7 text-muted mt-2" id="etherscan-wrap">Contract: <a href="#" id="etherscan-link" target="_blank" rel="noopener">View on Etherscan</a></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- How It Works Section -->
        <div id="how-it-works" class="section panel overflow-hidden">
            <div class="section-outer panel py-6 sm:py-8 lg:py-9 xl:py-10 bg-secondary-100">
                <div class="container sm:max-w-lg xl:max-w-2xl">
                    <div class="section-inner panel">
                        <div class="text-center mb-4"
                            data-anime="onview: -400; translateY: [24, 0]; opacity: [0, 1]; delay: 200;">
                            <h2 class="h5 sm:h3 xl:h2 mb-0 ls-0 text-uppercase -rotate-1">How It Works</h2>
                            <p class="fs-6 sm:fs-5 text-muted mt-2">Four steps. Fully onchain. No middlemen.</p>
                        </div>
                        <div class="how-it-works-grid"
                            data-anime="onview: -300; targets: >*; translateY: [24, 0]; opacity: [0, 1]; delay: anime.stagger(100, {start: 300});">
                            <div class="panel p-3 border border-2 border-black contrast-shadow-sm bg-white rounded-2 text-center">
                                <div class="step-num border border-2 border-black bg-secondary-200 mx-auto mb-2">1</div>
                                <h4 class="fs-6 fw-bold mb-1">Connect Wallet</h4>
                                <p class="fs-7 text-muted mb-0">Connect your Ethereum wallet (MetaMask, WalletConnect, etc).</p>
                            </div>
                            <div class="panel p-3 border border-2 border-black contrast-shadow-sm bg-white rounded-2 text-center">
                                <div class="step-num border border-2 border-black bg-secondary-200 mx-auto mb-2">2</div>
                                <h4 class="fs-6 fw-bold mb-1">Approve Token</h4>
                                <p class="fs-7 text-muted mb-0">Approve the market contract to transfer the token you want to sell (ü¶Ñ or wüçñ).</p>
                            </div>
                            <div class="panel p-3 border border-2 border-black contrast-shadow-sm bg-white rounded-2 text-center">
                                <div class="step-num border border-2 border-black bg-secondary-200 mx-auto mb-2">3</div>
                                <h4 class="fs-6 fw-bold mb-1">Place or Take</h4>
                                <p class="fs-7 text-muted mb-0">Place a new order or take an existing one. Partial fills are supported.</p>
                            </div>
                            <div class="panel p-3 border border-2 border-black contrast-shadow-sm bg-white rounded-2 text-center">
                                <div class="step-num border border-2 border-black bg-secondary-200 mx-auto mb-2">4</div>
                                <h4 class="fs-6 fw-bold mb-1">Settled Onchain</h4>
                                <p class="fs-7 text-muted mb-0">Tokens transfer directly between maker and taker. No escrow beyond the order itself.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        </main>

        <footer id="uc-footer" class="uc-footer panel overflow-hidden" style="background-color: #dbf2ff">
            <div class="footer-content panel bg-primary-400 text-white" style="margin-top: -1px">
                <div class="container">
                    <div class="footer-inner panel vstack lg:hstack gap-4 justify-between fs-5 xl:fs-4 text-center py-4 lg:py-6">
                        <p>Unicorn Meat &copy; 2026, All rights reserved.</p>
                        <ul class="nav-x gap-0 row child-cols-auto justify-center gx-4 gy-2 lg:g-4">
                            <li><a href="/#about">About</a></li>
                            <li><a href="/#trading">Buy üçñ</a></li>
                            <li><a href="/how-to-buy">How to Buy</a></li>
                            <li><a href="/#wrap">Wrap ü¶Ñüçñ</a></li>
                            <li><a href="/#join-herd">ü¶Ñ Herd</a></li>
                            <li><a href="/grinder-association">ü¶Ñüçñ Grinder</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UNICORN MARKET ‚Äî PRODUCTION ONCHAIN ORDERBOOK
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // ‚îÄ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const CONTRACT_ADDRESS = '0xA352B50A91C648c97F7aC0a80D686D297b62693E'; // UPDATE ON DEPLOY
    const RPC_URLS = [
        'https://rarible.com/nodes/ethereum-node',
        'https://eth-mainnet.g.alchemy.com/v2/J3_kv3R_rj4tIrl60I1dQcLvkmIPaTyE',
    ];
    const CHAIN_ID = 1; // Ethereum Mainnet

    const UNICORN  = '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7';
    const W_UNICORN = '0x38a9aF1BD00f9988977095B31eb18d6D3D5dCA00';
    const MEAT     = '0xED6aC8de7c7CA7e3A22952e09C2a2A1232DDef9A';
    const W_MEAT   = '0xDFA208BB0B811cFBB5Fa3Ea98Ec37Aa86180e668';

    const REFRESH_INTERVAL = 15000;
    const EVENT_LOOKBACK_BLOCKS = 1000;
    const DEPLOYMENT_BLOCK = 24500943;

    // ‚îÄ‚îÄ‚îÄ ABIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const MARKET_ABI = [
        'function placeOrder(address sellToken, address buyToken, uint256 sellAmount, uint256 buyAmount) external returns (uint256 orderId)',
        'function fillOrder(uint256 orderId, uint256 sellAmountToTake) external',
        'function fillOrderFull(uint256 orderId) external',
        'function cancelOrder(uint256 orderId) external',
        'function getOrder(uint256 orderId) external view returns (tuple(address maker, address sellToken, address buyToken, uint256 sellAmountTotal, uint256 buyAmountTotal, uint256 sellAmountRemaining, uint256 buyAmountRemaining, uint64 createdAt, uint8 status))',
        'function getOrderBook(address sellToken, address buyToken) external view returns (uint256[])',
        'function orderCount() external view returns (uint256)',
        'event OrderPlaced(uint256 indexed orderId, address indexed maker, address sellToken, address buyToken, uint256 sellAmountTotal, uint256 buyAmountTotal)',
        'event OrderFilled(uint256 indexed orderId, address indexed taker, uint256 sellAmountFilled, uint256 buyAmountPaid, uint256 sellAmountRemaining, uint256 buyAmountRemaining)',
        'event OrderCancelled(uint256 indexed orderId, address indexed maker, uint256 sellAmountRefunded)',
    ];

    const ERC20_ABI = [
        'function balanceOf(address) view returns (uint256)',
        'function allowance(address owner, address spender) view returns (uint256)',
        'function approve(address spender, uint256 amount) returns (bool)',
    ];

    // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let readProvider = null;
    let signer = null;
    let userAddress = null;
    let marketRead = null;
    let marketWrite = null;
    let asks = [];    // [{id, maker, sellToken, buyToken, sellTotal, buyTotal, sellRem, buyRem, price}]
    let bids = [];
    let ledgerEntries = [];
    let refreshTimer = null;
    let activeFillId = null;
    let txPending = false;
    let refreshTick = 0;
    let currentRpcIndex = 0;

    // ‚îÄ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const asksEl = document.getElementById('asks');
    const bidsEl = document.getElementById('bids');
    const ledgerEl = document.getElementById('ledger');
    const depthEl = document.getElementById('depth');
    const statsEl = document.getElementById('stats');
    const myOrdersEl = document.getElementById('my-orders');
    const balancesEl = document.getElementById('balances');
    const previewEl = document.getElementById('preview');
    const txStatusEl = document.getElementById('tx-status');
    const createBtn = document.getElementById('create-order');
    const sideEl = document.getElementById('side');
    const amountEl = document.getElementById('amount');
    const priceEl = document.getElementById('price');
    const amountLabel = document.getElementById('amount-label');
    const priceLabel = document.getElementById('price-label');
    const approvalHelp = document.getElementById('approval-help');

    // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const fmt = (n) => Number(n).toLocaleString(undefined, { maximumFractionDigits: 3 });
    const shortAddr = (a) => a ? a.slice(0,6) + '‚Ä¶' + a.slice(-4) : '';

    function isUnicornSide(token) {
        return token.toLowerCase() === UNICORN.toLowerCase() || token.toLowerCase() === W_UNICORN.toLowerCase();
    }

    // W_MEAT has 3 decimals. UNICORN/W_UNICORN/MEAT have 0 decimals.
    function displayAmount(token, rawAmount) {
        const n = Number(rawAmount);
        if (token.toLowerCase() === W_MEAT.toLowerCase()) {
            return fmt(n / 1000);
        }
        return fmt(n);
    }

    function tokenSymbol(token) {
        const t = token.toLowerCase();
        if (t === UNICORN.toLowerCase()) return 'ü¶Ñ';
        if (t === W_UNICORN.toLowerCase()) return 'wü¶Ñ';
        if (t === MEAT.toLowerCase()) return 'üçñ';
        if (t === W_MEAT.toLowerCase()) return 'wüçñ';
        return '???';
    }

    // Calculate price as wüçñ per ü¶Ñ
    function calcPrice(order) {
        const sell = Number(order.sellTotal || order.sellAmountTotal);
        const buy = Number(order.buyTotal || order.buyAmountTotal);
        if (sell === 0 || buy === 0) return 0;
        if (isUnicornSide(order.sellToken)) {
            // Selling unicorns, buying meat: price = buyAmount(meat) / 1000 / sellAmount(unicorn)
            return (buy / 1000) / sell;
        } else {
            // Selling meat, buying unicorns: price = sellAmount(meat) / 1000 / buyAmount(unicorn)
            return (sell / 1000) / buy;
        }
    }

    function showTxStatus(msg, type) {
        txStatusEl.innerHTML = `<div class="tx-status ${type}">${msg}</div>`;
        if (type === 'success') setTimeout(() => { txStatusEl.innerHTML = ''; }, 8000);
    }

    function clearTxStatus() { txStatusEl.innerHTML = ''; }

    // ‚îÄ‚îÄ‚îÄ Etherscan link ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('etherscan-link').href = `https://etherscan.io/address/${CONTRACT_ADDRESS}`;

    // ‚îÄ‚îÄ‚îÄ Initialize Provider ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function initProvider() {
        try {
            let connected = false;
            let lastErr;
            for (let i = 0; i < RPC_URLS.length; i++) {
                try {
                    const p = new ethers.JsonRpcProvider(RPC_URLS[i], 1, { staticNetwork: true });
                    const c = new ethers.Contract(CONTRACT_ADDRESS, MARKET_ABI, p);
                    const count = await c.orderCount();
                    readProvider = p;
                    marketRead = c;
                    currentRpcIndex = i;
                    connected = true;
                    console.log('UnicornMarket connected via RPC', RPC_URLS[i], 'orderCount:', count.toString());
                    break;
                } catch (e) {
                    lastErr = e;
                }
            }
            if (!connected) throw lastErr || new Error('No RPC available');

            await loadOrderbook();
            await loadLedger();
            startAutoRefresh();
        } catch (e) {
            console.error('Init error:', e);
            asksEl.innerHTML = '<p class="fs-7 text-muted text-center py-2 mb-0">Unable to load orderbook ‚Äî check console for details</p>';
            bidsEl.innerHTML = '<p class="fs-7 text-muted text-center py-2 mb-0"><button onclick="initProvider()" style="cursor:pointer;text-decoration:underline;background:none;border:none;color:#6c757d;font-size:inherit;">Retry</button></p>';
        }
    }

    // ‚îÄ‚îÄ‚îÄ Wallet Connection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function connectWallet() {
        if (!window.ethereum) {
            alert('Please install MetaMask or another Ethereum wallet');
            return;
        }
        try {
            // Request accounts first
            await window.ethereum.request({ method: 'eth_requestAccounts' });

            // Resolve chain id with broad compatibility
            let chainIdNum;
            try {
                const chainHex = await window.ethereum.request({ method: 'eth_chainId' });
                chainIdNum = parseInt(chainHex, 16);
            } catch (_) {
                // Fallback for older/non-standard providers
                const netVersion = await window.ethereum.request({ method: 'net_version' });
                chainIdNum = Number(netVersion);
            }

            if (chainIdNum !== CHAIN_ID) {
                document.getElementById('network-warning').style.display = 'block';
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x1' }],
                    });
                } catch (e) {
                    showTxStatus('Please switch wallet to Ethereum Mainnet', 'error');
                    return;
                }
            }
            document.getElementById('network-warning').style.display = 'none';

            const provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            marketWrite = new ethers.Contract(CONTRACT_ADDRESS, MARKET_ABI, signer);

            // Update all wallet buttons
            document.querySelectorAll('.connect-wallet-btn .btn-responsive-text').forEach(el => {
                el.textContent = shortAddr(userAddress);
            });

            createBtn.disabled = false;

            await updateBalances();
            await refreshApprovalState();
            render();
        } catch (e) {
            console.error('Wallet connect error:', e);
        }
    }

    // Listen for account/chain changes (no hard reload loops)
    if (window.ethereum) {
        window.ethereum.on('accountsChanged', async (accounts) => {
            if (!accounts || accounts.length === 0) {
                userAddress = null;
                signer = null;
                marketWrite = null;
                document.querySelectorAll('.connect-wallet-btn .btn-responsive-text').forEach(el => {
                    el.textContent = 'Connect Wallet';
                });
                await refreshApprovalState();
                render();
                return;
            }
            userAddress = accounts[0];
            const provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            marketWrite = new ethers.Contract(CONTRACT_ADDRESS, MARKET_ABI, signer);
            document.querySelectorAll('.connect-wallet-btn .btn-responsive-text').forEach(el => {
                el.textContent = shortAddr(userAddress);
            });
            await updateBalances();
            await refreshApprovalState();
            render();
        });

        window.ethereum.on('chainChanged', async () => {
            // Re-run wallet setup without forcing full page reload
            if (userAddress) {
                await connectWallet();
                await refreshAll();
            }
        });
    }

    async function updateBalances() {
        if (!userAddress || !readProvider) return;
        try {
            const unicornToken = new ethers.Contract(UNICORN, ERC20_ABI, readProvider);
            const wMeatToken = new ethers.Contract(W_MEAT, ERC20_ABI, readProvider);
            const [uBal, mBal] = await Promise.all([
                unicornToken.balanceOf(userAddress),
                wMeatToken.balanceOf(userAddress),
            ]);
            balancesEl.innerHTML = `
                <span class="bal">ü¶Ñ ${fmt(Number(uBal))}</span>
                <span class="bal">wüçñ ${fmt(Number(mBal) / 1000)}</span>
            `;
        } catch (e) {
            console.warn('Balance fetch failed:', e);
        }
    }

    // ‚îÄ‚îÄ‚îÄ Load Orderbook ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadOrderbook() {
        try {
            // Asks: selling UNICORN for W_MEAT
            const askIds = await marketRead.getOrderBook(UNICORN, W_MEAT);
            const askOrders = await Promise.all(askIds.map(async (id) => {
                const o = await marketRead.getOrder(id);
                return {
                    id: Number(id), maker: o.maker, sellToken: o.sellToken, buyToken: o.buyToken,
                    sellTotal: Number(o.sellAmountTotal), buyTotal: Number(o.buyAmountTotal),
                    sellRem: Number(o.sellAmountRemaining), buyRem: Number(o.buyAmountRemaining),
                    sellAmountTotal: Number(o.sellAmountTotal), buyAmountTotal: Number(o.buyAmountTotal),
                };
            }));

            // Bids: selling W_MEAT for UNICORN
            const bidIds = await marketRead.getOrderBook(W_MEAT, UNICORN);
            const bidOrders = await Promise.all(bidIds.map(async (id) => {
                const o = await marketRead.getOrder(id);
                return {
                    id: Number(id), maker: o.maker, sellToken: o.sellToken, buyToken: o.buyToken,
                    sellTotal: Number(o.sellAmountTotal), buyTotal: Number(o.buyAmountTotal),
                    sellRem: Number(o.sellAmountRemaining), buyRem: Number(o.buyAmountRemaining),
                    sellAmountTotal: Number(o.sellAmountTotal), buyAmountTotal: Number(o.buyAmountTotal),
                };
            }));

            asks = askOrders.map(o => ({ ...o, price: calcPrice(o) }));
            bids = bidOrders.map(o => ({ ...o, price: calcPrice(o) }));

            render();
        } catch (e) {
            console.error('Orderbook load error:', e);
            if (currentRpcIndex < RPC_URLS.length - 1) {
                try {
                    currentRpcIndex += 1;
                    readProvider = new ethers.JsonRpcProvider(RPC_URLS[currentRpcIndex], 1, { staticNetwork: true });
                    marketRead = new ethers.Contract(CONTRACT_ADDRESS, MARKET_ABI, readProvider);
                    await loadOrderbook();
                    return;
                } catch (_) {}
            }
            asksEl.innerHTML = '<p class="fs-7 text-muted text-center py-2 mb-0">Unable to load ‚Äî contract may not be deployed yet</p>';
            bidsEl.innerHTML = asksEl.innerHTML;
        }
    }

    async function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    async function getLogsChunked(topics0, fromBlock, toBlock) {
        // Free-tier RPC can cap eth_getLogs ranges and request rates.
        // Query in small chunks, combine all market event topics in one pass.
        const chunkSize = 10;
        const out = [];
        for (let start = fromBlock; start <= toBlock; start += chunkSize) {
            const end = Math.min(toBlock, start + chunkSize - 1);
            try {
                const logs = await readProvider.getLogs({
                    address: CONTRACT_ADDRESS,
                    topics: [topics0],
                    fromBlock: start,
                    toBlock: end,
                });
                if (logs && logs.length) out.push(...logs);
            } catch (e) {
                // Skip failed chunks instead of failing the whole ledger.
                console.warn('getLogs chunk failed', { start, end, err: e?.shortMessage || e?.message || e });
            }
            await sleep(25);
        }
        return out;
    }

    // ‚îÄ‚îÄ‚îÄ Load Ledger (Events) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadLedger() {
        try {
            const currentBlock = await readProvider.getBlockNumber();
            const fromBlock = Math.max(DEPLOYMENT_BLOCK, currentBlock - EVENT_LOOKBACK_BLOCKS);
            const iface = new ethers.Interface(MARKET_ABI);

            const topicPlaced = ethers.id('OrderPlaced(uint256,address,address,address,uint256,uint256)').toLowerCase();
            const topicFilled = ethers.id('OrderFilled(uint256,address,uint256,uint256,uint256,uint256)').toLowerCase();
            const topicCancelled = ethers.id('OrderCancelled(uint256,address,uint256)').toLowerCase();

            const allLogs = await getLogsChunked([topicPlaced, topicFilled, topicCancelled], fromBlock, currentBlock);

            ledgerEntries = [];

            for (const log of allLogs) {
                const parsed = iface.parseLog(log);
                const t0 = (log.topics?.[0] || '').toLowerCase();

                if (t0 === topicPlaced) {
                    const sym = tokenSymbol(parsed.args.sellToken);
                    const amt = isUnicornSide(parsed.args.sellToken)
                        ? `${fmt(Number(parsed.args.sellAmountTotal))} ${sym}`
                        : `${fmt(Number(parsed.args.sellAmountTotal) / 1000)} ${sym}`;
                    ledgerEntries.push({ block: log.blockNumber, text: `Placed #${Number(parsed.args.orderId)} ¬∑ ${amt} by ${shortAddr(parsed.args.maker)}` });
                } else if (t0 === topicFilled) {
                    ledgerEntries.push({ block: log.blockNumber, text: `Filled #${Number(parsed.args.orderId)} ¬∑ took ${fmt(Number(parsed.args.sellAmountFilled))} for ${fmt(Number(parsed.args.buyAmountPaid))} by ${shortAddr(parsed.args.taker)}` });
                } else if (t0 === topicCancelled) {
                    ledgerEntries.push({ block: log.blockNumber, text: `Cancelled #${Number(parsed.args.orderId)} ¬∑ ${fmt(Number(parsed.args.sellAmountRefunded))} refunded to ${shortAddr(parsed.args.maker)}` });
                }
            }

            ledgerEntries.sort((a, b) => b.block - a.block);
            renderLedger();
        } catch (e) {
            console.warn('Ledger load error:', e);
            // One-shot RPC failover for ledger reads
            if (currentRpcIndex < RPC_URLS.length - 1) {
                try {
                    currentRpcIndex += 1;
                    readProvider = new ethers.JsonRpcProvider(RPC_URLS[currentRpcIndex], 1, { staticNetwork: true });
                    marketRead = new ethers.Contract(CONTRACT_ADDRESS, MARKET_ABI, readProvider);
                    await loadLedger();
                    return;
                } catch (_) {}
            }
            ledgerEl.innerHTML = '<p class="fs-7 text-muted text-center py-2 mb-0">Unable to load events</p>';
        }
    }

    // ‚îÄ‚îÄ‚îÄ Auto Refresh ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function startAutoRefresh() {
        if (refreshTimer) clearInterval(refreshTimer);
        refreshTimer = setInterval(async () => {
            refreshTick += 1;
            await loadOrderbook();
            // Ledger refresh every ~60s (4 ticks) to avoid heavy getLogs traffic
            if (refreshTick % 4 === 0) {
                await loadLedger();
            }
            if (userAddress) await updateBalances();
        }, REFRESH_INTERVAL);
    }

    async function refreshAll() {
        await loadOrderbook();
        await loadLedger();
        if (userAddress) await updateBalances();
    }

    // ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function render() {
        renderAsks();
        renderBids();
        renderDepth();
        renderStats();
        renderMyOrders();
        renderLedger();
    }

    function renderAsks() {
        if (asks.length === 0) {
            asksEl.innerHTML = '<p class="fs-7 text-muted text-center py-2 mb-0">No asks yet ‚Äî place the first one!</p>';
            return;
        }
        const sorted = [...asks].sort((a, b) => b.price - a.price);
        asksEl.innerHTML = sorted.map(a => {
            const isMine = userAddress && a.maker.toLowerCase() === userAddress.toLowerCase();
            let actions = '';
            if (userAddress && !isMine) {
                if (activeFillId === a.id) {
                    actions = `
                        <div class="fill-inline">
                            <input type="number" id="fill-amount-${a.id}" placeholder="${a.sellRem}" min="1" max="${a.sellRem}" value="${a.sellRem}" />
                            <button class="fill-confirm" onclick="doFillOrder(${a.id}, 'ask')">Fill</button>
                            <button class="fill-all" onclick="doFillOrderFull(${a.id})">All</button>
                        </div>`;
                } else {
                    actions = `<button class="take-btn" onclick="toggleFill(${a.id})">Take</button>`;
                }
            } else if (isMine) {
                actions = `<button class="cancel-btn" onclick="doCancelOrder(${a.id})">Cancel</button>`;
            }
            return `<div class="market-row">
                <span>${fmt(a.sellRem)} ü¶Ñ</span>
                <span class="ask-color">${fmt(a.price)}</span>
                ${actions}
            </div>`;
        }).join('');
    }

    function renderBids() {
        if (bids.length === 0) {
            bidsEl.innerHTML = '<p class="fs-7 text-muted text-center py-2 mb-0">No bids yet ‚Äî place the first one!</p>';
            return;
        }
        const sorted = [...bids].sort((a, b) => b.price - a.price);
        bidsEl.innerHTML = sorted.map(b => {
            const isMine = userAddress && b.maker.toLowerCase() === userAddress.toLowerCase();
            // For bids, sellRem is in W_MEAT raw (3 dec), buyRem is in UNICORN (0 dec)
            const displaySell = fmt(b.sellRem / 1000);
            let actions = '';
            if (userAddress && !isMine) {
                if (activeFillId === b.id) {
                    // For bids, taker takes wüçñ by providing ü¶Ñ. sellAmountToTake is in wüçñ raw.
                    actions = `
                        <div class="fill-inline">
                            <input type="number" id="fill-amount-${b.id}" placeholder="${b.sellRem}" min="1" max="${b.sellRem}" value="${b.sellRem}" step="1000" />
                            <button class="fill-confirm" onclick="doFillOrder(${b.id}, 'bid')">Fill</button>
                            <button class="fill-all" onclick="doFillOrderFull(${b.id})">All</button>
                        </div>`;
                } else {
                    actions = `<button class="take-btn" onclick="toggleFill(${b.id})">Take</button>`;
                }
            } else if (isMine) {
                actions = `<button class="cancel-btn" onclick="doCancelOrder(${b.id})">Cancel</button>`;
            }
            return `<div class="market-row">
                <span>${displaySell} wüçñ</span>
                <span class="bid-color">${fmt(b.price)}</span>
                ${actions}
            </div>`;
        }).join('');
    }

    function renderDepth() {
        const allAsks = [...asks].sort((a, b) => a.price - b.price);
        const allBids = [...bids].sort((a, b) => b.price - a.price);
        const maxAskAmt = Math.max(...asks.map(a => a.sellRem), 1);
        const maxBidAmt = Math.max(...bids.map(b => b.sellRem / 1000), 1);

        const bestAsk = allAsks[0]?.price || 0;
        const bestBid = allBids[0]?.price || 0;
        const mid = bestAsk && bestBid ? ((bestAsk + bestBid) / 2) : (bestAsk || bestBid || 0);

        depthEl.innerHTML = `
            ${allAsks.map(a => `
                <div class="depth-row ask">
                    <div class="bar" style="width:${(a.sellRem / maxAskAmt) * 100}%"></div>
                    <span>${fmt(a.sellRem)} ü¶Ñ</span><span class="ask-color">${fmt(a.price)}</span><span>ask</span>
                </div>`).join('')}
            ${mid ? `<div class="depth-mid">Mid: ${fmt(mid)} wüçñ/ü¶Ñ</div>` : '<div class="depth-mid">No orders</div>'}
            ${allBids.map(b => `
                <div class="depth-row bid">
                    <div class="bar" style="width:${((b.sellRem / 1000) / maxBidAmt) * 100}%"></div>
                    <span>${fmt(b.sellRem / 1000)} wüçñ</span><span class="bid-color">${fmt(b.price)}</span><span>bid</span>
                </div>`).join('')}
        `;
    }

    function renderStats() {
        const bestAsk = asks.length ? Math.min(...asks.map(a => a.price)) : 0;
        const bestBid = bids.length ? Math.max(...bids.map(b => b.price)) : 0;
        const spread = bestAsk && bestBid ? bestAsk - bestBid : 0;
        const mid = bestAsk && bestBid ? (bestAsk + bestBid) / 2 : 0;
        const spreadPct = mid ? ((spread / mid) * 100).toFixed(2) : '0.00';

        // Volume from filled events
        const filledCount = ledgerEntries.filter(e => e.text.startsWith('Filled')).length;

        statsEl.innerHTML = `
            <div class="stat-card panel p-2 border border-2 border-black contrast-shadow-sm bg-white rounded-2"><span class="k">Best Bid</span><span class="v bid-color">${bestBid ? fmt(bestBid) + ' wüçñ' : '‚Äî'}</span></div>
            <div class="stat-card panel p-2 border border-2 border-black contrast-shadow-sm bg-white rounded-2"><span class="k">Best Ask</span><span class="v ask-color">${bestAsk ? fmt(bestAsk) + ' wüçñ' : '‚Äî'}</span></div>
            <div class="stat-card panel p-2 border border-2 border-black contrast-shadow-sm bg-white rounded-2"><span class="k">Spread</span><span class="v">${spread ? fmt(spread) + ' (' + spreadPct + '%)' : '‚Äî'}</span></div>
            <div class="stat-card panel p-2 border border-2 border-black contrast-shadow-sm bg-white rounded-2"><span class="k">Fills</span><span class="v">${filledCount}</span></div>
        `;
    }

    function renderLedger() {
        if (ledgerEntries.length === 0) {
            ledgerEl.innerHTML = '<p class="fs-7 text-muted text-center py-2 mb-0">No events yet</p>';
            return;
        }
        ledgerEl.innerHTML = ledgerEntries.slice(0, 20).map(e =>
            `<div class="market-row"><span class="fs-7">${e.text}</span></div>`
        ).join('');
    }

    function renderMyOrders() {
        if (!userAddress) {
            myOrdersEl.innerHTML = '<p class="fs-7 text-muted mb-0">Connect wallet to see your orders</p>';
            return;
        }
        const mine = [...asks, ...bids].filter(o => o.maker.toLowerCase() === userAddress.toLowerCase());
        if (mine.length === 0) {
            myOrdersEl.innerHTML = '<p class="fs-7 text-muted mb-0">No open orders</p>';
            return;
        }
        myOrdersEl.innerHTML = mine.map(o => {
            const isAsk = isUnicornSide(o.sellToken);
            const label = isAsk
                ? `${fmt(o.sellRem)} ü¶Ñ ask @ ${fmt(o.price)} wüçñ`
                : `${fmt(o.sellRem / 1000)} wüçñ bid @ ${fmt(o.price)} wüçñ`;
            return `<div class="my-order-row">
                <span>#${o.id} ¬∑ ${label}</span>
                <button class="cancel-btn" onclick="doCancelOrder(${o.id})">Cancel</button>
            </div>`;
        }).join('');
    }

    // ‚îÄ‚îÄ‚îÄ Trade Ticket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updatePreview() {
        const side = sideEl.value;
        const amount = Number(amountEl.value || 0);
        const price = Number(priceEl.value || 0);
        if (!amount || !price) { previewEl.textContent = '‚Äî'; return; }

        if (side === 'ask') {
            amountLabel.textContent = 'Amount (ü¶Ñ)';
            priceLabel.textContent = 'Price (wüçñ per ü¶Ñ)';
            amountEl.placeholder = '0';
            priceEl.placeholder = '0';
            priceEl.step = 'any';
            const total = amount * price;
            previewEl.textContent = `Sell ${fmt(amount)} ü¶Ñ for ${fmt(total)} wüçñ (@ ${fmt(price)} wüçñ/ü¶Ñ)`;
        } else {
            amountLabel.textContent = 'Total Offered (wüçñ)';
            priceLabel.textContent = 'Unicorns Wanted (whole number)';
            amountEl.placeholder = 'e.g. 5000';
            priceEl.placeholder = 'e.g. 2';
            priceEl.step = '1';
            const unicornsWanted = Math.floor(price);
            if (unicornsWanted <= 0) { previewEl.textContent = 'Enter at least 1 unicorn'; return; }
            const implied = amount / unicornsWanted;
            previewEl.textContent = `Offer ${fmt(amount)} wüçñ for ${fmt(unicornsWanted)} ü¶Ñ (implied ${fmt(implied)} wüçñ/ü¶Ñ)`;
        }
    }

    function getOrderDraft() {
        const side = sideEl.value;
        const amount = Number(amountEl.value || 0);
        const price = Number(priceEl.value || 0);
        if (!amount || !price || amount <= 0 || price <= 0) return null;

        let sellToken, buyToken, sellAmount, buyAmount;
        if (side === 'ask') {
            sellToken = UNICORN;
            buyToken = W_MEAT;
            sellAmount = BigInt(Math.floor(amount));
            buyAmount = BigInt(Math.floor(amount * price * 1000));
        } else {
            const unicornsWanted = Math.floor(price);
            if (!Number.isInteger(unicornsWanted) || unicornsWanted <= 0) return null;
            sellToken = W_MEAT;
            buyToken = UNICORN;
            sellAmount = BigInt(Math.floor(amount * 1000));
            buyAmount = BigInt(unicornsWanted);
        }

        if (sellAmount <= 0n || buyAmount <= 0n) return null;
        return { side, amount, price, sellToken, buyToken, sellAmount, buyAmount };
    }

    async function refreshApprovalState() {
        if (!userAddress || !signer) {
            createBtn.textContent = 'Connect Wallet';
            approvalHelp.textContent = 'Order placement uses two transactions when needed: Approve token (if allowance is insufficient), then Place Order.';
            return;
        }
        if (txPending) return;

        const draft = getOrderDraft();
        if (!draft) {
            createBtn.textContent = 'Enter Order Details';
            approvalHelp.textContent = 'Fill in amount and price. If allowance is low, the first click will be Approve, then Place Order.';
            return;
        }

        try {
            const token = new ethers.Contract(draft.sellToken, ERC20_ABI, readProvider);
            const allowance = await token.allowance(userAddress, CONTRACT_ADDRESS);
            const approved = allowance >= draft.sellAmount;
            createBtn.textContent = approved ? 'Place Order' : 'Approve';
            approvalHelp.textContent = approved
                ? 'Allowance is sufficient. Next transaction will place your order.'
                : 'Step 1 of 2: Approve this token spend. After approval confirms, Step 2 will switch to Place Order.';
        } catch (e) {
            createBtn.textContent = 'Place Order';
            approvalHelp.textContent = 'Could not verify allowance right now. If needed, you will be prompted to approve first.';
        }
    }

    sideEl.addEventListener('change', () => { updatePreview(); refreshApprovalState(); });
    amountEl.addEventListener('input', () => { updatePreview(); refreshApprovalState(); });
    priceEl.addEventListener('input', () => { updatePreview(); refreshApprovalState(); });

    // ‚îÄ‚îÄ‚îÄ Place Order ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    createBtn.addEventListener('click', async () => {
        if (!userAddress) { connectWallet(); return; }
        if (!marketWrite) return;
        if (txPending) return;

        const draft = getOrderDraft();
        if (!draft) {
            showTxStatus('Enter valid order inputs', 'error');
            return;
        }

        const { sellToken, buyToken, sellAmount, buyAmount } = draft;

        txPending = true;
        createBtn.disabled = true;
        createBtn.textContent = 'Checking allowance...';

        try {
            const token = new ethers.Contract(sellToken, ERC20_ABI, signer);
            const allowance = await token.allowance(userAddress, CONTRACT_ADDRESS);

            if (allowance < sellAmount) {
                // Step 1 only: approve, then return. Next click places order.
                showTxStatus('Step 1/2: Approve token spend in wallet', 'pending');
                createBtn.textContent = 'Approve in wallet...';
                const approveTx = await token.approve(CONTRACT_ADDRESS, sellAmount);
                showTxStatus('Waiting for approval confirmation...', 'pending');
                await approveTx.wait();
                showTxStatus('Approval confirmed. Step 2/2: click Place Order.', 'success');
                await refreshApprovalState();
                return;
            }

            // Step 2: place order
            showTxStatus('Step 2/2: Placing order...', 'pending');
            createBtn.textContent = 'Confirm in wallet...';
            const tx = await marketWrite.placeOrder(sellToken, buyToken, sellAmount, buyAmount);
            showTxStatus(`TX submitted: ${shortAddr(tx.hash)}`, 'pending');
            createBtn.textContent = 'Waiting for confirmation...';
            const receipt = await tx.wait();
            showTxStatus(`Order placed! TX: ${shortAddr(receipt.hash)}`, 'success');

            amountEl.value = '';
            priceEl.value = '';
            previewEl.textContent = '‚Äî';
            await refreshAll();
        } catch (e) {
            console.error('Place order error:', e);
            const reason = e.reason || e.shortMessage || e.message || 'Transaction failed';
            showTxStatus(reason, 'error');
        } finally {
            txPending = false;
            createBtn.disabled = false;
            await refreshApprovalState();
        }
    });

    // ‚îÄ‚îÄ‚îÄ Fill Order ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleFill(orderId) {
        activeFillId = activeFillId === orderId ? null : orderId;
        render();
        if (activeFillId !== null) {
            setTimeout(() => {
                const inp = document.getElementById('fill-amount-' + orderId);
                if (inp) inp.focus();
            }, 50);
        }
    }

    async function doFillOrder(orderId, side) {
        if (!marketWrite || txPending) return;
        const inp = document.getElementById('fill-amount-' + orderId);
        const fillAmount = BigInt(inp ? inp.value : 0);
        if (fillAmount <= 0n) return;

        // Find the order to determine buyToken for approval
        const order = [...asks, ...bids].find(o => o.id === orderId);
        if (!order) return;

        txPending = true;
        try {
            // Taker pays buyToken. Calculate approximate buyAmountToPay.
            const buyAmountApprox = (fillAmount * BigInt(order.buyTotal)) / BigInt(order.sellTotal) + 1n;
            const buyTokenContract = new ethers.Contract(order.buyToken, ERC20_ABI, signer);
            const allowance = await buyTokenContract.allowance(userAddress, CONTRACT_ADDRESS);
            if (allowance < buyAmountApprox) {
                showTxStatus('Approving token...', 'pending');
                const approveTx = await buyTokenContract.approve(CONTRACT_ADDRESS, buyAmountApprox);
                await approveTx.wait();
            }

            showTxStatus('Filling order...', 'pending');
            const tx = await marketWrite.fillOrder(orderId, fillAmount);
            showTxStatus(`TX submitted: ${shortAddr(tx.hash)}`, 'pending');
            await tx.wait();
            showTxStatus('Order filled!', 'success');
            activeFillId = null;
            await refreshAll();
        } catch (e) {
            console.error('Fill order error:', e);
            showTxStatus(e.reason || e.shortMessage || 'Fill failed', 'error');
        } finally {
            txPending = false;
        }
    }

    async function doFillOrderFull(orderId) {
        if (!marketWrite || txPending) return;
        const order = [...asks, ...bids].find(o => o.id === orderId);
        if (!order) return;

        txPending = true;
        try {
            const buyTokenContract = new ethers.Contract(order.buyToken, ERC20_ABI, signer);
            const allowance = await buyTokenContract.allowance(userAddress, CONTRACT_ADDRESS);
            if (allowance < BigInt(order.buyRem)) {
                showTxStatus('Approving token...', 'pending');
                const approveTx = await buyTokenContract.approve(CONTRACT_ADDRESS, BigInt(order.buyRem));
                await approveTx.wait();
            }

            showTxStatus('Filling entire order...', 'pending');
            const tx = await marketWrite.fillOrderFull(orderId);
            showTxStatus(`TX submitted: ${shortAddr(tx.hash)}`, 'pending');
            await tx.wait();
            showTxStatus('Order fully filled!', 'success');
            activeFillId = null;
            await refreshAll();
        } catch (e) {
            console.error('Fill full error:', e);
            showTxStatus(e.reason || e.shortMessage || 'Fill failed', 'error');
        } finally {
            txPending = false;
        }
    }

    // ‚îÄ‚îÄ‚îÄ Cancel Order ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function doCancelOrder(orderId) {
        if (!userAddress) {
            showTxStatus('Connect wallet first', 'error');
            return;
        }
        if (!marketWrite) {
            showTxStatus('Wallet not ready on mainnet', 'error');
            return;
        }
        if (txPending) {
            showTxStatus('Another transaction is in progress', 'pending');
            return;
        }

        const order = [...asks, ...bids].find(o => Number(o.id) === Number(orderId));
        if (!order) {
            showTxStatus('Order not found (it may have been filled/cancelled already)', 'error');
            return;
        }
        if (order.maker.toLowerCase() !== userAddress.toLowerCase()) {
            showTxStatus('Only the maker can cancel this order', 'error');
            return;
        }

        txPending = true;
        try {
            showTxStatus('Cancelling order... Confirm in wallet', 'pending');
            const tx = await marketWrite.cancelOrder(orderId);
            showTxStatus(`TX submitted: ${shortAddr(tx.hash)}`, 'pending');
            await tx.wait();
            showTxStatus('Order cancelled!', 'success');
            await refreshAll();
        } catch (e) {
            console.error('Cancel error:', e);
            showTxStatus(e.reason || e.shortMessage || 'Cancel failed', 'error');
        } finally {
            txPending = false;
        }
    }

    // ‚îÄ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    updatePreview();
    initProvider();

    // Silent reconnect (no wallet prompt loop)
    if (window.ethereum) {
        window.ethereum.request({ method: 'eth_accounts' }).then(async (accounts) => {
            if (!accounts || accounts.length === 0) return;
            try {
                userAddress = accounts[0];
                const provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                marketWrite = new ethers.Contract(CONTRACT_ADDRESS, MARKET_ABI, signer);
                document.querySelectorAll('.connect-wallet-btn .btn-responsive-text').forEach(el => {
                    el.textContent = shortAddr(userAddress);
                });
                await updateBalances();
                await refreshApprovalState();
                render();
            } catch (e) {
                console.warn('Silent reconnect failed', e);
            }
        });
    }
    </script>

    <script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
